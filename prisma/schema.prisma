generator client {
  provider = "prisma-client-js"
}

datasource db {
  provider = "postgresql"
  url      = env("DATABASE_URL")
}

model Contractor {
  id               String   @id @default(uuid())
  email            String   @unique
  passwordHash     String
  companyName      String
  trade            String   // 'flooring', 'painting', 'drywall'
  phone            String?
  logoUrl          String?
  defaultMarkup    Float    @default(50)
  defaultTaxRate   Float    @default(0)
  defaultLaborCost Float    @default(0)
  notifyOnAccept   Boolean  @default(true)
  notifyOnDecline  Boolean  @default(true)
  subscriptionPlan String   @default("free") // 'free', 'pro', 'business'
  stripeCustomerId String?
  createdAt        DateTime @default(now())

  customers      Customer[]
  quotes         Quote[]
  materials      MaterialCost[]
  quoteTemplates QuoteTemplate[]
}

model Customer {
  id           String     @id @default(uuid())
  contractorId String
  contractor   Contractor @relation(fields: [contractorId], references: [id])
  name         String
  email        String?
  phone        String?
  address      String?
  notes        String?
  createdAt    DateTime   @default(now())

  quotes     Quote[]
  floorPlans FloorPlan[]

  @@index([contractorId])
}

model FloorPlan {
  id             String   @id @default(uuid())
  customerId     String
  customer       Customer @relation(fields: [customerId], references: [id])
  fileUrl        String
  fileType       String   // 'pdf', 'image'
  totalSquareFeet Float?
  roomsData      Json?    // Store room dimensions as JSON
  createdAt      DateTime @default(now())

  quotes Quote[]

  @@index([customerId])
}

model Quote {
  id           String     @id @default(uuid())
  contractorId String
  contractor   Contractor @relation(fields: [contractorId], references: [id])
  customerId   String
  customer     Customer   @relation(fields: [customerId], references: [id])
  floorPlanId  String?
  floorPlan    FloorPlan? @relation(fields: [floorPlanId], references: [id])

  quoteNumber String @unique
  publicToken String @unique @default(uuid())
  trade       String // 'flooring', 'painting', 'drywall'
  status      String @default("draft") // 'draft', 'sent', 'accepted', 'rejected'

  // Materials calculated (stored as JSON)
  materials Json // [{item: 'Hardwood', qty: 500, unit: 'sqft', cost: 2500}]

  // Pricing
  subtotal      Float
  laborCost     Float?
  markupPercent Float  @default(50)
  taxRate       Float  @default(0)
  total         Float

  // Metadata
  pdfUrl        String?
  sentAt        DateTime?
  viewedAt      DateTime?
  acceptedAt    DateTime?
  signatureData String?   // base64 PNG of customer signature
  createdAt     DateTime  @default(now())

  @@index([contractorId, createdAt])
  @@index([contractorId, status])
  @@index([customerId])
}

model QuoteTemplate {
  id           String     @id @default(uuid())
  contractorId String
  contractor   Contractor @relation(fields: [contractorId], references: [id])
  name         String
  trade        String     // 'flooring', 'painting', 'drywall'
  materials    Json       // same format as Quote.materials
  markupPercent Float     @default(50)
  laborCost     Float?
  taxRate       Float     @default(0)
  createdAt    DateTime   @default(now())

  @@index([contractorId])
}

model MaterialCost {
  id           String  @id @default(uuid())
  contractorId String? // null = default pricing
  contractor   Contractor? @relation(fields: [contractorId], references: [id])
  category     String  // 'flooring', 'paint', 'drywall'
  materialType String  // 'hardwood', 'interior_paint', 'drywall_sheet'
  unit         String  // 'sqft', 'gallon', 'sheet'
  costPerUnit  Float
  updatedAt    DateTime @updatedAt

  @@index([contractorId])
  @@index([category])
}
