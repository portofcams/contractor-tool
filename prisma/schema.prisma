generator client {
  provider = "prisma-client-js"
}

datasource db {
  provider = "postgresql"
  url      = env("DATABASE_URL")
}

model Contractor {
  id               String   @id @default(uuid())
  email            String   @unique
  passwordHash     String
  companyName      String
  trade            String   // 'flooring', 'painting', 'drywall'
  phone            String?
  logoUrl          String?
  defaultMarkup    Float    @default(50)
  defaultTaxRate   Float    @default(0)
  defaultLaborCost Float    @default(0)
  notifyOnAccept   Boolean  @default(true)
  notifyOnDecline  Boolean  @default(true)
  subscriptionPlan String   @default("free") // 'free', 'pro', 'business'
  stripeCustomerId String?
  createdAt        DateTime @default(now())

  customers      Customer[]
  quotes         Quote[]
  materials      MaterialCost[]
  quoteTemplates QuoteTemplate[]
  roomScans      RoomScan[]
  sitePhotos     SitePhoto[]
  siteNotes      SiteNote[]
  voiceNotes     VoiceNote[]
  followUps      FollowUp[]
  jobs           Job[]
  invoices       Invoice[]
  crewMembers    CrewMember[]
  actualCosts    ActualCost[]
}

model Customer {
  id           String     @id @default(uuid())
  contractorId String
  contractor   Contractor @relation(fields: [contractorId], references: [id])
  name         String
  email        String?
  phone        String?
  address      String?
  notes        String?
  createdAt    DateTime   @default(now())

  quotes     Quote[]
  floorPlans FloorPlan[]
  roomScans  RoomScan[]
  sitePhotos SitePhoto[]
  siteNotes  SiteNote[]
  voiceNotes VoiceNote[]
  jobs       Job[]
  invoices   Invoice[]

  @@index([contractorId])
}

model FloorPlan {
  id             String   @id @default(uuid())
  customerId     String
  customer       Customer @relation(fields: [customerId], references: [id])
  fileUrl        String
  fileType       String   // 'pdf', 'image'
  totalSquareFeet Float?
  roomsData      Json?    // Store room dimensions as JSON
  createdAt      DateTime @default(now())

  quotes Quote[]

  @@index([customerId])
}

model Quote {
  id           String     @id @default(uuid())
  contractorId String
  contractor   Contractor @relation(fields: [contractorId], references: [id])
  customerId   String
  customer     Customer   @relation(fields: [customerId], references: [id])
  floorPlanId  String?
  floorPlan    FloorPlan? @relation(fields: [floorPlanId], references: [id])

  quoteNumber String @unique
  publicToken String @unique @default(uuid())
  trade       String // 'flooring', 'painting', 'drywall' or comma-separated
  status      String @default("draft") // 'draft', 'sent', 'accepted', 'rejected'

  // Materials calculated (stored as JSON)
  materials Json // [{item: 'Hardwood', qty: 500, unit: 'sqft', cost: 2500}]

  // Pricing
  subtotal      Float
  laborCost     Float?
  markupPercent Float  @default(50)
  taxRate       Float  @default(0)
  total         Float

  // Metadata
  pdfUrl        String?
  sentAt        DateTime?
  viewedAt      DateTime?
  acceptedAt    DateTime?
  signatureData String?   // base64 PNG of customer signature
  createdAt     DateTime  @default(now())

  roomScans  RoomScan[]
  sitePhotos SitePhoto[]
  siteNotes  SiteNote[]
  voiceNotes VoiceNote[]
  followUps  FollowUp[]
  job        Job?
  invoices   Invoice[]

  @@index([contractorId, createdAt])
  @@index([contractorId, status])
  @@index([customerId])
}

model QuoteTemplate {
  id           String     @id @default(uuid())
  contractorId String
  contractor   Contractor @relation(fields: [contractorId], references: [id])
  name         String
  trade        String     // 'flooring', 'painting', 'drywall'
  materials    Json       // same format as Quote.materials
  markupPercent Float     @default(50)
  laborCost     Float?
  taxRate       Float     @default(0)
  createdAt    DateTime   @default(now())

  @@index([contractorId])
}

model MaterialCost {
  id           String  @id @default(uuid())
  contractorId String? // null = default pricing
  contractor   Contractor? @relation(fields: [contractorId], references: [id])
  category     String  // 'flooring', 'paint', 'drywall'
  materialType String  // 'hardwood', 'interior_paint', 'drywall_sheet'
  unit         String  // 'sqft', 'gallon', 'sheet'
  costPerUnit  Float
  updatedAt    DateTime @updatedAt

  @@index([contractorId])
  @@index([category])
}

model RoomScan {
  id           String     @id @default(uuid())
  contractorId String
  contractor   Contractor @relation(fields: [contractorId], references: [id], onDelete: Cascade)
  customerId   String?
  customer     Customer?  @relation(fields: [customerId], references: [id], onDelete: SetNull)
  quoteId      String?
  quote        Quote?     @relation(fields: [quoteId], references: [id], onDelete: SetNull)
  roomsData    Json       // [{ name, length, width, height, floorArea, wallArea }]
  surfaceCount Int        @default(0)
  scanDate     DateTime   @default(now())
  notes        String?

  @@index([contractorId])
  @@index([customerId])
}

model SitePhoto {
  id           String     @id @default(uuid())
  contractorId String
  contractor   Contractor @relation(fields: [contractorId], references: [id], onDelete: Cascade)
  customerId   String?
  customer     Customer?  @relation(fields: [customerId], references: [id], onDelete: SetNull)
  quoteId      String?
  quote        Quote?     @relation(fields: [quoteId], references: [id], onDelete: SetNull)
  fileUrl      String
  caption      String?
  photoType    String     @default("general") // "general", "before", "after"
  takenAt      DateTime   @default(now())

  @@index([contractorId])
  @@index([customerId])
  @@index([quoteId])
}

model SiteNote {
  id           String     @id @default(uuid())
  contractorId String
  contractor   Contractor @relation(fields: [contractorId], references: [id], onDelete: Cascade)
  customerId   String?
  customer     Customer?  @relation(fields: [customerId], references: [id], onDelete: SetNull)
  quoteId      String?
  quote        Quote?     @relation(fields: [quoteId], references: [id], onDelete: SetNull)
  content      String
  createdAt    DateTime   @default(now())
  updatedAt    DateTime   @updatedAt

  @@index([contractorId])
  @@index([customerId])
  @@index([quoteId])
}

model VoiceNote {
  id           String     @id @default(uuid())
  contractorId String
  contractor   Contractor @relation(fields: [contractorId], references: [id], onDelete: Cascade)
  customerId   String?
  customer     Customer?  @relation(fields: [customerId], references: [id], onDelete: SetNull)
  quoteId      String?
  quote        Quote?     @relation(fields: [quoteId], references: [id], onDelete: SetNull)
  fileUrl      String
  duration     Int        // seconds
  transcript   String?
  createdAt    DateTime   @default(now())

  @@index([contractorId])
  @@index([customerId])
}

model FollowUp {
  id           String     @id @default(uuid())
  contractorId String
  contractor   Contractor @relation(fields: [contractorId], references: [id], onDelete: Cascade)
  quoteId      String
  quote        Quote      @relation(fields: [quoteId], references: [id], onDelete: Cascade)
  reminderDate DateTime
  message      String?
  status       String     @default("pending") // "pending", "sent", "dismissed"
  createdAt    DateTime   @default(now())

  @@index([contractorId])
  @@index([quoteId])
  @@index([reminderDate])
}

model Job {
  id            String     @id @default(uuid())
  contractorId  String
  contractor    Contractor @relation(fields: [contractorId], references: [id], onDelete: Cascade)
  quoteId       String     @unique
  quote         Quote      @relation(fields: [quoteId], references: [id], onDelete: Cascade)
  customerId    String
  customer      Customer   @relation(fields: [customerId], references: [id])
  scheduledDate DateTime
  scheduledEnd  DateTime?
  status        String     @default("scheduled") // "scheduled", "in_progress", "completed", "cancelled"
  notes         String?
  createdAt     DateTime   @default(now())

  assignments JobAssignment[]
  actualCosts ActualCost[]

  @@index([contractorId])
  @@index([customerId])
  @@index([scheduledDate])
}

model Invoice {
  id              String     @id @default(uuid())
  contractorId    String
  contractor      Contractor @relation(fields: [contractorId], references: [id], onDelete: Cascade)
  quoteId         String
  quote           Quote      @relation(fields: [quoteId], references: [id], onDelete: Cascade)
  customerId      String
  customer        Customer   @relation(fields: [customerId], references: [id])
  invoiceNumber   String     @unique
  amount          Float
  paidAmount      Float      @default(0)
  status          String     @default("unpaid") // "unpaid", "partial", "paid"
  dueDate         DateTime
  stripePaymentLink String?
  paidAt          DateTime?
  createdAt       DateTime   @default(now())

  @@index([contractorId])
  @@index([customerId])
  @@index([status])
}

model ActualCost {
  id           String     @id @default(uuid())
  contractorId String
  contractor   Contractor @relation(fields: [contractorId], references: [id], onDelete: Cascade)
  jobId        String
  job          Job        @relation(fields: [jobId], references: [id], onDelete: Cascade)
  description  String
  amount       Float
  category     String     // "materials", "labor", "other"
  receiptUrl   String?
  createdAt    DateTime   @default(now())

  @@index([jobId])
}

model CrewMember {
  id           String     @id @default(uuid())
  contractorId String
  contractor   Contractor @relation(fields: [contractorId], references: [id], onDelete: Cascade)
  name         String
  phone        String?
  email        String?
  role         String?    // "lead", "helper", "subcontractor"
  hourlyRate   Float?
  active       Boolean    @default(true)
  createdAt    DateTime   @default(now())

  assignments JobAssignment[]

  @@index([contractorId])
}

model JobAssignment {
  id           String     @id @default(uuid())
  jobId        String
  job          Job        @relation(fields: [jobId], references: [id], onDelete: Cascade)
  crewMemberId String
  crewMember   CrewMember @relation(fields: [crewMemberId], references: [id], onDelete: Cascade)
  hoursWorked  Float?
  notes        String?
  createdAt    DateTime   @default(now())

  @@index([jobId])
  @@index([crewMemberId])
}
