# ─────────────────────────────────────────────────────────────
# GitHub Actions — ContractorCalc Deploy Pipeline
# ─────────────────────────────────────────────────────────────
#
# Trigger: Push to `main` branch
#
# What it does:
#   1. Lint & type-check the codebase
#   2. Build the Next.js production bundle
#   3. Run Prisma migrations on the production DB
#   4. Deploy to Vultr VPS via SSH
#
# Required GitHub Secrets:
#   VULTR_HOST          — VPS IP address (e.g. 149.28.xxx.xxx)
#   VULTR_USER          — SSH user (e.g. deploy)
#   VULTR_SSH_KEY       — Private SSH key for deployment
#   DATABASE_URL        — Production PostgreSQL connection string
#   NEXTAUTH_SECRET     — Production auth secret
#   NEXTAUTH_URL        — Production URL (https://contractorcalc.com)
#
# Optional Secrets (add when ready):
#   STRIPE_SECRET_KEY, STRIPE_PUBLISHABLE_KEY, STRIPE_WEBHOOK_SECRET
#   RESEND_API_KEY
#   S3_ACCESS_KEY, S3_SECRET_KEY, S3_BUCKET, S3_REGION
# ─────────────────────────────────────────────────────────────

name: Deploy to Vultr

on:
  push:
    branches: [main]
  workflow_dispatch: # Allow manual trigger

jobs:
  lint-and-typecheck:
    name: Lint & Type Check
    runs-on: ubuntu-latest
    steps:
      - uses: actions/checkout@v4

      - uses: actions/setup-node@v4
        with:
          node-version: 20
          cache: "npm"

      - run: npm ci

      - name: Generate Prisma Client
        run: npx prisma generate

      - name: Lint
        run: npm run lint

      - name: Type Check
        run: npx tsc --noEmit

  build-and-deploy:
    name: Build & Deploy
    needs: lint-and-typecheck
    runs-on: ubuntu-latest
    steps:
      - uses: actions/checkout@v4

      - uses: actions/setup-node@v4
        with:
          node-version: 20
          cache: "npm"

      - run: npm ci

      - name: Generate Prisma Client
        run: npx prisma generate

      - name: Build Next.js
        run: npm run build
        env:
          DATABASE_URL: ${{ secrets.DATABASE_URL }}
          NEXTAUTH_SECRET: ${{ secrets.NEXTAUTH_SECRET }}
          NEXTAUTH_URL: ${{ secrets.NEXTAUTH_URL }}

      - name: Deploy to Vultr via SSH
        uses: appleboy/ssh-action@v1
        with:
          host: ${{ secrets.VULTR_HOST }}
          username: ${{ secrets.VULTR_USER }}
          key: ${{ secrets.VULTR_SSH_KEY }}
          script: |
            cd /opt/contractorcalc
            git pull origin main
            npm ci --production
            npx prisma generate
            npx prisma migrate deploy
            npm run build
            pm2 restart contractorcalc || pm2 start npm --name contractorcalc -- start

  notify:
    name: Post-Deploy
    needs: build-and-deploy
    runs-on: ubuntu-latest
    if: always()
    steps:
      - name: Deploy Status
        run: |
          if [ "${{ needs.build-and-deploy.result }}" = "success" ]; then
            echo "✅ Deployment successful"
          else
            echo "❌ Deployment failed"
          fi
